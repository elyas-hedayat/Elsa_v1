name: CI

on:
  push:
    branches:
      - "feature/*"

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  test:
    name: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync --extra dev

      - name: Run pre-commit checks
        run: |
          uv run pre-commit run --all-files

      - name: Setup CI environment
        run: cp .env.ci .env

      - name: Run pytest with coverage
        run: |
          uv run pytest -v

  create-pull-request:
    name: Create or Update PR
    needs: test
    runs-on: ubuntu-latest
    if: success()

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$PR_NUMBER" ]; then
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          else
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Found existing PR #$PR_NUMBER"
          fi

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"

          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "üöÄ Merge $BRANCH_NAME into main" \
            --body "## ‚úÖ CI Passed - Ready for Review

          **Branch:** \`$BRANCH_NAME\`
          **Target:** \`main\`

          ### üìä CI Results
          - ‚úÖ Linting passed
          - ‚úÖ Tests passed
          - ‚úÖ Coverage checks passed

          ### üìù Description
          This PR was automatically created after all CI checks passed successfully.

          Please review the changes and merge when ready.

          ---
          **Author:** @${{ github.actor }}
          **Commit:** \`${{ github.sha }}\`
          **Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Update existing PR
        if: steps.check-pr.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.check-pr.outputs.pr_number }}"

          gh pr comment $PR_NUMBER --body "‚úÖ **CI passed** on commit \`${{ github.sha }}\`

          All checks have passed successfully. This PR is ready for review.

          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
